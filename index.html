<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Serial Keeper</title>
<style>
  :root{--fg:#111;--muted:#666;--line:#e9e9e9;--chip:#f7f7f7;--ok:#0a7a2f;--ng:#b42318;--blue:#3b82f6;}
  body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;background:#fff;color:var(--fg);}
  header{position:sticky;top:0;z-index:10;background:#fff;padding:14px 16px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--line);}
  h1{margin:0;font-size:18px;font-weight:700;letter-spacing:.2px;}
  .chips{display:flex;gap:8px;align-items:center;}
  .chip{font-size:13px;padding:7px 10px;border-radius:999px;border:1px solid var(--line);background:var(--chip);white-space:nowrap;}
  main{padding:16px;max-width:720px;margin:0 auto;}
  .card{border:1px solid var(--line);border-radius:16px;overflow:hidden;background:#fff;}
  .pad{padding:14px;}
  label{display:block;font-size:12px;color:var(--muted);margin-bottom:8px;}
  input{width:100%;box-sizing:border-box;padding:14px 14px;font-size:18px;border-radius:14px;border:1px solid var(--line);outline:none;background:#fff;}
  .note{margin-top:8px;font-size:12px;color:var(--muted);}
  .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;}
  button{border:1px solid var(--line);background:#fff;color:var(--fg);padding:12px 14px;border-radius:14px;font-size:14px;cursor:pointer;}
  button.primary{background:#111;color:#fff;border-color:#111;}
  .status{margin-top:10px;font-size:13px;color:var(--muted);}
  .status b{color:var(--fg);}
  .ok{color:var(--ok);font-weight:700;}
  .ng{color:var(--ng);font-weight:700;}

  .cameraWrap{margin-top:12px;border-radius:16px;overflow:hidden;border:1px solid var(--line);background:#000;position:relative;}
  #cameraBox{position:relative;width:100%;aspect-ratio: 3 / 4; background:#000;}
  video, canvas{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;}
  .frame{
    position:absolute;left:9%;top:58%;width:82%;height:26%;
    border:2px solid rgba(59,130,246,.95);border-radius:16px;
    box-shadow:0 0 0 9999px rgba(0,0,0,.35) inset;pointer-events:none;
  }
  .overlayText{position:absolute;left:0;right:0;bottom:10px;text-align:center;font-size:12px;color:#fff;opacity:.9;text-shadow:0 1px 2px rgba(0,0,0,.6);padding:0 10px;}
  .list{margin-top:14px;border:1px solid var(--line);border-radius:16px;overflow:hidden;}
  .listHead{padding:10px 12px;background:#fafafa;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center;font-size:12px;color:var(--muted);}
  table{width:100%;border-collapse:collapse;font-size:13px;}
  td,th{padding:10px 12px;border-bottom:1px solid var(--line);text-align:left;}
  tr:last-child td{border-bottom:none;}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;letter-spacing:.2px;}
  .hint{margin-top:8px;font-size:12px;color:var(--muted);line-height:1.45;}
</style>
</head>

<body>
<header>
  <h1>Serial Keeper</h1>
  <div class="chips">
    <div class="chip" id="inquiryChip">Inquiry No.: —</div>
    <div class="chip" id="savedChip">Saved: 0</div>
  </div>
</header>

<main>
  <div class="card">
    <div class="pad">
      <label>問い合わせ番号（数字5桁-数字7桁 / 自動確定）</label>
      <input id="inquiryInput" inputmode="numeric" autocomplete="off" placeholder="12345-1234567">
      <div class="note">※ 形式が合った時だけ保存できます（Enter不要）</div>

      <div class="row">
        <button class="primary" id="btnStart">カメラ開始</button>
        <button id="btnExport">CSV出力</button>
        <button id="btnClear">全削除</button>
      </div>

      <div class="cameraWrap" id="cameraWrap" style="display:none;">
        <div id="cameraBox">
          <video id="video" playsinline autoplay muted></video>
          <canvas id="overlay"></canvas>
          <div class="frame"></div>
          <div class="overlayText">枠に “Serial No.” のバーコードだけ入れてください（Code128 / 自動保存）</div>
        </div>
      </div>

      <div class="status" id="status"><b>待機中</b>：問い合わせ番号 → カメラ開始</div>
      <div class="hint">
        うまく読めない時：①明るい場所 ②箱を少し離す（10〜20cm）③枠にバーコードだけ入れる ④手ブレを止める
      </div>
    </div>
  </div>

  <div class="list">
    <div class="listHead">
      <div>保存履歴（最新100件）</div>
      <div class="mono" id="dupInfo"></div>
    </div>
    <div style="max-height:360px; overflow:auto;">
      <table>
        <thead><tr><th style="width:34%;">Inquiry</th><th style="width:30%;">Serial</th><th>Time</th></tr></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>
</main>

<!-- Quagga2 (Safariでも動くことが多い) -->
<script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2@1.2.6/dist/quagga.min.js"></script>

<script>
/** 条件 */
const SERIAL_RE  = /^(?=.*[A-Z])[A-Z0-9]{10}$/; // 10桁 / 英大文字+数字のみ / 英字必須
const INQUIRY_RE = /^\d{5}-\d{7}$/;            // 5-7
const LS_KEY = "serial_keeper_quagga_records";

/** 状態 */
let inquiryNo = "";
let records = loadRecords();
let running = false;
let lastAccepted = { serial:"", at:0 };

/** DOM */
const inquiryInput = document.getElementById("inquiryInput");
const inquiryChip  = document.getElementById("inquiryChip");
const savedChip    = document.getElementById("savedChip");
const btnStart     = document.getElementById("btnStart");
const btnExport    = document.getElementById("btnExport");
const btnClear     = document.getElementById("btnClear");
const statusEl     = document.getElementById("status");
const cameraWrap   = document.getElementById("cameraWrap");
const tbody        = document.getElementById("tbody");
const dupInfo      = document.getElementById("dupInfo");

function setStatus(text, tone){
  statusEl.innerHTML = `<b class="${tone==='ok'?'ok':tone==='ng'?'ng':''}">${text}</b>`;
}
function refreshTable(){
  const show = records.slice(-100).reverse();
  tbody.innerHTML = show.map(r => `
    <tr>
      <td class="mono">${esc(r.inquiry)}</td>
      <td class="mono">${esc(r.serial)}</td>
      <td>${new Date(r.at).toLocaleString()}</td>
    </tr>`).join("");
  savedChip.textContent = `Saved: ${records.length}`;
}
function esc(s){return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}

function normalizeRaw(raw){
  if(!raw) return "";
  return String(raw).toUpperCase().trim().replace(/[^A-Z0-9]/g,"");
}

function tryAccept(rawValue){
  if(!inquiryNo || !INQUIRY_RE.test(inquiryNo)) return;
  const serial = normalizeRaw(rawValue);
  if(!SERIAL_RE.test(serial)) return;

  const now = Date.now();
  if (serial === lastAccepted.serial && (now - lastAccepted.at) < 1200) return;
  lastAccepted = { serial, at: now };

  const exists = records.some(r => r.serial === serial);
  if (exists){
    dupInfo.textContent = `DUP: ${serial}`;
    setTimeout(()=>dupInfo.textContent="", 1200);
    return;
  }
  records.push({ inquiry: inquiryNo, serial, at: now });
  saveRecords(records);
  refreshTable();
  try{ navigator.vibrate && navigator.vibrate(30);}catch(e){}
}

/** 問い合わせ番号：Enter不要で自動確定 */
inquiryInput.addEventListener("input", () => {
  let digits = inquiryInput.value.replace(/[^\d]/g,"");
  if(digits.length>12) digits = digits.slice(0,12);
  let v = digits.length>5 ? (digits.slice(0,5)+"-"+digits.slice(5)) : digits;
  inquiryInput.value = v;

  if(INQUIRY_RE.test(v)){
    inquiryNo = v;
    inquiryChip.textContent = `Inquiry No.: ${v}`;
    setStatus("読み取り待機中：カメラ開始してください", "ok");
  }else{
    inquiryNo = "";
    inquiryChip.textContent = "Inquiry No.: —";
    setStatus("問い合わせ番号が未確定です（12345-1234567）", "ng");
  }
});

/** Quagga：Code128だけ読む（Serial用） */
async function start(){
  if(!INQUIRY_RE.test(inquiryNo)){
    setStatus("問い合わせ番号を先に確定してください（12345-1234567）", "ng");
    return;
  }
  cameraWrap.style.display = "block";
  setStatus("読み取り中：Serialのバーコードを枠に（Serialだけ保存）", "ok");

  return new Promise((resolve, reject)=>{
    Quagga.init({
      inputStream: {
        name: "Live",
        type: "LiveStream",
        target: document.querySelector("#cameraBox"),
        constraints: {
          facingMode: "environment",
          width: { ideal: 1280 },
          height:{ ideal: 720 }
        },
        // 枠あたりを優先（下のSerial帯に合わせた比率）
        area: { top: "58%", right: "9%", left: "9%", bottom: "16%" }
      },
      decoder: {
        readers: ["code_128_reader"],   // ← ここが重要：Code128だけ
        multiple: true
      },
      locate: true,
      numOfWorkers: 0                   // iOS Safariは0が安定しがち
    }, (err)=>{
      if(err){
        cameraWrap.style.display = "none";
        reject(err);
        return;
      }
      Quagga.start();
      running = true;
      resolve();
    });
  });
}

function stop(){
  try{ Quagga.stop(); }catch(e){}
  running = false;
  cameraWrap.style.display = "none";
}

Quagga.onDetected((data)=>{
  try{
    const code = data?.codeResult?.code;
    if(code) tryAccept(code);
  }catch(e){}
});

/** ボタン */
btnStart.addEventListener("click", async ()=>{
  if(running){
    stop();
    btnStart.textContent = "カメラ開始";
    setStatus("停止しました：再開する場合はカメラ開始", "ok");
  }else{
    btnStart.textContent = "起動中...";
    try{
      await start();
      btnStart.textContent = "停止";
    }catch(e){
      btnStart.textContent = "カメラ開始";
      setStatus("カメラ起動に失敗：Safariのカメラ許可をON / HTTPSで開いてるか確認", "ng");
    }
  }
});

btnExport.addEventListener("click", ()=>{
  const header=["Inquiry","Serial","ScannedAt"];
  const rows=records.map(r=>[r.inquiry,r.serial,new Date(r.at).toISOString()]);
  const csv=[header,...rows].map(cols=>cols.map(csvEsc).join(",")).join("\n");
  const blob=new Blob([csv],{type:"text/csv;charset=utf-8"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  const ymd=new Date().toISOString().slice(0,10).replaceAll("-","");
  a.href=url; a.download=`serial_${ymd}.csv`;
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
});
function csvEsc(v){ const s=String(v??""); return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s; }

btnClear.addEventListener("click", ()=>{
  if(!confirm("保存データを全削除します。よろしいですか？")) return;
  records=[]; saveRecords(records); refreshTable(); setStatus("全削除しました","ok");
});

/** 永続化 */
function loadRecords(){
  try{const raw=localStorage.getItem(LS_KEY);const arr=raw?JSON.parse(raw):[];return Array.isArray(arr)?arr:[];}catch(e){return[];}
}
function saveRecords(arr){
  try{localStorage.setItem(LS_KEY, JSON.stringify(arr));}catch(e){}
}

/** 初期 */
refreshTable();
</script>
</body>
</html>
