<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Serial Keeper</title>

<style>
  :root{
    --fg:#0b0b0b; --muted:#6b7280; --line:#e5e7eb; --bg:#ffffff; --chip:#f3f4f6;
    --ok:#0a7a2f; --ng:#b42318; --blue:#2563eb;
    --radius:18px;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;background:var(--bg);color:var(--fg);}
  header{
    position:sticky; top:0; z-index:10;
    background:rgba(255,255,255,.94); backdrop-filter:saturate(180%) blur(10px);
    border-bottom:1px solid var(--line);
    padding:12px 14px;
    display:flex; align-items:center; justify-content:space-between; gap:10px;
  }
  h1{margin:0;font-size:16px;font-weight:900;letter-spacing:.2px;}
  .right{display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:flex-end;}
  .chip{
    font-size:12px; padding:7px 10px; border-radius:999px;
    border:1px solid var(--line); background:var(--chip); white-space:nowrap;
  }
  main{padding:14px; max-width:820px; margin:0 auto;}
  .card{border:1px solid var(--line); border-radius:var(--radius); background:#fff; overflow:hidden;}
  .pad{padding:14px;}
  label{display:block; font-size:12px; color:var(--muted); font-weight:800; margin-bottom:8px;}
  input{
    width:100%; padding:14px; font-size:18px; border-radius:14px;
    border:1px solid var(--line); outline:none; letter-spacing:.3px;
  }
  input:focus{border-color:rgba(37,99,235,.55); box-shadow:0 0 0 4px rgba(37,99,235,.12);}
  .row{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; align-items:center;}
  button{
    border:1px solid var(--line); background:#fff; color:var(--fg);
    padding:12px 14px; border-radius:14px; font-size:14px;
    cursor:pointer; font-weight:800;
  }
  button.primary{background:#0b0b0b; color:#fff; border-color:#0b0b0b;}
  button:active{transform:translateY(1px);}
  .status{margin-top:10px; font-size:13px; color:var(--muted); line-height:1.45;}
  .status b{color:var(--fg);}
  .ok{color:var(--ok); font-weight:900;}
  .ng{color:var(--ng); font-weight:900;}
  .note{margin-top:10px; font-size:12px; color:var(--muted); line-height:1.45;}

  /* カメラ */
  .cameraWrap{margin-top:14px; border-radius:var(--radius); overflow:hidden; border:1px solid var(--line); background:#000;}
  #cameraBox{position:relative; width:100%; aspect-ratio: 3 / 4; background:#000;}
  video{position:absolute; inset:0; width:100%; height:100%; object-fit:cover;}
  .frame{
    position:absolute; left:6%; top:40%; width:88%; height:52%;
    border:2px solid rgba(37,99,235,.95); border-radius:16px;
    box-shadow:0 0 0 9999px rgba(0,0,0,.32) inset; pointer-events:none;
  }
  .overlayText{
    position:absolute; left:0; right:0; bottom:10px; text-align:center;
    font-size:12px; color:#fff; opacity:.92; text-shadow:0 1px 2px rgba(0,0,0,.65);
    padding:0 12px; line-height:1.35;
  }

  /* モード切替（連続 / 1個ずつ） */
  .seg{
    display:flex; border:1px solid var(--line); border-radius:999px; overflow:hidden;
    background:#fff;
  }
  .seg button{
    border:0; border-right:1px solid var(--line);
    padding:8px 12px; border-radius:0; background:#fff; font-size:12px;
    font-weight:900;
  }
  .seg button:last-child{border-right:0;}
  .seg button.active{background:#111; color:#fff;}
</style>
</head>

<body>
<header>
  <h1>Serial Keeper</h1>
  <div class="right">
    <div class="seg" aria-label="scan mode">
      <button id="modeContinuous" class="active" type="button">連続</button>
      <button id="modeSingle" type="button">1個ずつ</button>
    </div>
    <div class="chip" id="inquiryChip">Inquiry: —</div>
    <div class="chip" id="savedChip">Saved: 0</div>
  </div>
</header>

<main>
  <div class="card">
    <div class="pad">
      <label>問い合わせ番号（数字5桁-数字7桁 / 自動確定）</label>
      <input id="inquiryInput" inputmode="numeric" autocomplete="off" placeholder="12345-1234567" />
      <div class="row">
        <button id="btnStart" class="primary" type="button">カメラ開始</button>
        <button id="btnStop" type="button" disabled>停止</button>
        <button id="btnExport" type="button">CSV出力</button>
        <button id="btnClear" type="button">全削除</button>
      </div>

      <div class="cameraWrap" id="cameraWrap" style="display:none;">
        <div id="cameraBox">
          <video id="video" playsinline autoplay muted></video>
          <div class="frame"></div>
          <div class="overlayText" id="overlayText">
            ラベル全体を映してOK（保存：英字入り10桁のみ）
          </div>
        </div>
      </div>

      <div class="status" id="status"><b class="ng">問い合わせ番号を入力してください</b></div>
      <div class="note">
        コツ：①明るく ②反射回避（少し斜め）③10〜25cm ④手ブレ止め
      </div>
    </div>
  </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2@1.2.6/dist/quagga.min.js"></script>
<script>
  /** 条件 */
  const INQUIRY_RE = /^\d{5}-\d{7}$/;
  const SERIAL_RE  = /^(?=.*[A-Z])[A-Z0-9]{10}$/;   // 英大文字+数字のみ / 10桁 / 英字必須
  const LS_KEY = "serial_keeper_records_final";

  /** 状態 */
  let inquiryNo = "";
  let records = loadRecords();
  let running = false;

  // 連続 or 1個ずつ
  let scanMode = "continuous"; // "continuous" | "single"

  // 保存後の“誤連続”対策（同一でも別物でも、とにかく連打抑制）
  let lastSaveAt = 0;

  // 1個ずつモード用：保存後にロックして「箱がどいた」まで待つ
  let singleLocked = false;
  let lastDetectAt = 0;

  /** DOM */
  const inquiryInput = document.getElementById("inquiryInput");
  const inquiryChip  = document.getElementById("inquiryChip");
  const savedChip    = document.getElementById("savedChip");
  const statusEl     = document.getElementById("status");
  const cameraWrap   = document.getElementById("cameraWrap");
  const cameraBox    = document.getElementById("cameraBox");
  const overlayText  = document.getElementById("overlayText");

  const btnStart = document.getElementById("btnStart");
  const btnStop  = document.getElementById("btnStop");
  const btnExport= document.getElementById("btnExport");
  const btnClear = document.getElementById("btnClear");

  const modeContinuousBtn = document.getElementById("modeContinuous");
  const modeSingleBtn     = document.getElementById("modeSingle");

  /** UI */
  function setStatus(text, tone){
    statusEl.innerHTML = `<b class="${tone==='ok'?'ok':tone==='ng'?'ng':''}">${text}</b>`;
  }
  function refreshSaved(){
    savedChip.textContent = `Saved: ${records.length}`;
  }

  /** 問い合わせ番号（Enter不要） */
  inquiryInput.addEventListener("input", () => {
    let digits = inquiryInput.value.replace(/[^\d]/g, "");
    if (digits.length > 12) digits = digits.slice(0,12);
    inquiryInput.value = digits.length > 5
      ? digits.slice(0,5) + "-" + digits.slice(5)
      : digits;

    if (INQUIRY_RE.test(inquiryInput.value)) {
      inquiryNo = inquiryInput.value;
      inquiryChip.textContent = `Inquiry: ${inquiryNo}`;
      setStatus("OK：カメラ開始してください", "ok");
    } else {
      inquiryNo = "";
      inquiryChip.textContent = "Inquiry: —";
      setStatus("問い合わせ番号を入力してください（12345-1234567）", "ng");
    }
  });

  /** モード切替 */
  function setMode(mode){
    scanMode = mode;
    modeContinuousBtn.classList.toggle("active", mode==="continuous");
    modeSingleBtn.classList.toggle("active", mode==="single");
    overlayText.textContent = (mode==="single")
      ? "1個ずつ：保存したら箱をどけると次を自動受付"
      : "連続：保存したらすぐ次も読み続けます";
    // 途中切替時のロック解除
    singleLocked = false;
  }
  modeContinuousBtn.addEventListener("click", ()=>setMode("continuous"));
  modeSingleBtn.addEventListener("click", ()=>setMode("single"));

  /** 正規化 */
  function normalizeRaw(raw){
    return String(raw || "").toUpperCase().trim().replace(/[^A-Z0-9]/g, "");
  }

  /** 保存（問い合わせ番号ごと） */
  function saveSerial(serial){
    records.push({ inquiry: inquiryNo, serial, at: Date.now() });
    localStorage.setItem(LS_KEY, JSON.stringify(records));
    refreshSaved();
    try{ navigator.vibrate?.(25); }catch(e){}
  }

  /** 検出処理（ここが“連続/1個ずつ”の差だけ） */
  function handleDetected(rawValue){
    lastDetectAt = Date.now();

    if (!INQUIRY_RE.test(inquiryNo)) return;

    // 1個ずつモードでロック中は無視（箱がどくの待ち）
    if (scanMode === "single" && singleLocked) return;

    const serial = normalizeRaw(rawValue);
    if (!SERIAL_RE.test(serial)) return;

    const now = Date.now();

    // どちらのモードでも最低限の連打抑制（同じ箱を数フレーム拾う対策）
    if (now - lastSaveAt < 900) return;

    saveSerial(serial);
    lastSaveAt = now;

    // 1個ずつ：保存したらロック → “検出が止まった＝箱がどいた”で解除
    if (scanMode === "single") {
      singleLocked = true;
      setStatus("保存しました：箱をどけると次を受付します", "ok");
      // 箱がどいた判定を監視
      scheduleUnlockWatcher();
    } else {
      setStatus("保存しました（連続モード）", "ok");
    }
  }

  /** 1個ずつ：箱がどいたら自動で次へ */
  let unlockTimer = null;
  function scheduleUnlockWatcher(){
    if (unlockTimer) return;
    unlockTimer = setInterval(()=>{
      // 650ms以上 “検出イベントが来てない” = だいたい箱がどいた
      const idle = Date.now() - lastDetectAt;
      if (idle > 650) {
        singleLocked = false;
        clearInterval(unlockTimer);
        unlockTimer = null;
        setStatus("次をどうぞ（1個ずつモード）", "ok");
      }
    }, 200);
  }

  /** カメラ start/stop */
  function startCamera(){
    if (!INQUIRY_RE.test(inquiryNo)) {
      setStatus("問い合わせ番号を確定してから開始してください", "ng");
      return;
    }
    if (running) return;

    cameraWrap.style.display = "block";
    setStatus("起動中…", "ok");

    Quagga.init({
      inputStream: {
        name: "Live",
        type: "LiveStream",
        target: cameraBox,
        constraints: {
          facingMode: "environment",
          width:  { ideal: 1280 },
          height: { ideal: 720 }
        },
        // ラベル帯を広く（枠にシリアルだけ無理問題を回避）
        area: { top: "40%", right: "6%", left: "6%", bottom: "8%" }
      },
      decoder: {
        readers: ["code_128_reader"],
        multiple: true
      },
      locate: true,
      numOfWorkers: 0
    }, (err) => {
      if (err) {
        setStatus("カメラ起動に失敗しました（Safariのカメラ許可を確認）", "ng");
        cameraWrap.style.display = "none";
        return;
      }
      Quagga.start();
      running = true;
      btnStart.disabled = true;
      btnStop.disabled = false;
      setStatus("読み取り中", "ok");
    });
  }

  function stopCamera(){
    if (!running) return;
    try{ Quagga.stop(); }catch(e){}
    running = false;
    btnStart.disabled = false;
    btnStop.disabled = true;
    cameraWrap.style.display = "none";
    singleLocked = false;
    if (unlockTimer){ clearInterval(unlockTimer); unlockTimer = null; }
    setStatus("停止しました", "ok");
  }

  /** Quagga event（1回だけ登録） */
  Quagga.onDetected((data)=>{
    const code = data?.codeResult?.code;
    if (code) handleDetected(code);
  });

  /** buttons */
  btnStart.addEventListener("click", startCamera);
  btnStop.addEventListener("click", stopCamera);

  btnExport.addEventListener("click", ()=>{
    const header=["Inquiry","Serial","ScannedAt"];
    const rows=records.map(r=>[r.inquiry,r.serial,new Date(r.at).toISOString()]);
    const csv=[header,...rows].map(cols=>cols.map(csvEsc).join(",")).join("\n");
    const blob=new Blob([csv],{type:"text/csv;charset=utf-8"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a");
    const ymd=new Date().toISOString().slice(0,10).replaceAll("-","");
    a.href=url; a.download=`serial_${ymd}.csv`;
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  });
  function csvEsc(v){ const s=String(v??""); return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s; }

  btnClear.addEventListener("click", ()=>{
    if (!confirm("保存データを全削除します。よろしいですか？")) return;
    records = [];
    localStorage.setItem(LS_KEY, "[]");
    refreshSaved();
    setStatus("全削除しました", "ok");
  });

  /** storage */
  function loadRecords(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      const arr = raw ? JSON.parse(raw) : [];
      return Array.isArray(arr) ? arr : [];
    }catch(e){ return []; }
  }

  /** init */
  refreshSaved();
  setMode("continuous");
  setStatus("問い合わせ番号を入力してください（12345-1234567）", "ng");
</script>
</body>
</html>
